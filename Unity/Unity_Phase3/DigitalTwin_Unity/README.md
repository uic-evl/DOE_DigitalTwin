# Unity Phase 3

## Overview 
This is a sample scene that uses the Unity Robotics Hub URDF importer to import the Elephant Robotics Arm and control it either through Isaac Sim or the Elepahnt Robotics ROS2 nodes. 

This project was made in Unity version **2022.3.30f1**

This project requires an Isaac Sim counterpart scene. You can find this on Spirit's Nucleus under `"/Projects/Digital Twin/unity_connection/pos_from_unity.usd"`. The Unity application will connect to the Issac Sim USD stage when the OVIS simulation is running. The purpose of this connection is to have Unity send VR user inputs to OVIS so that OVIS can perform the IK computation. The results to this computation are then published so that they may be used by the virtual and physical arms. 

ZMQ-Unity code adapted from [gench23's repo](https://github.com/gench23/unity-zeromq-client)
ROS-Unity ArticulationBody control code adapted from [bryceikeda's repo](https://github.com/bryceikeda/SpotTutorial)

## Project Contents

Within the "Assets" folder, you will find the [typical Unity folder structure](https://github.com/uic-evl/digital-twin/tree/main/Unity#file-structure), with some additions related to the ROS Connection package. 

* `RosMessages`:
  * This folder is autogenerated as ROS messages are added as instructed [on our wiki](https://github.com/uic-evl/digital-twin/wiki/Connecting-Unity-to-ROS2-on-Ubuntu-and-Windows-10). 
  * If you need to create a RosMessage object, you can look for the constructors and class details in this folder. 
* `Scenes`:
  * `Bidirectional_ROS2`: 
    * Sample scene with a ROSPublisher and ROSSubscriber to control the arm from either the [Elephant Robotics ROS2 nodes](https://github.com/elephantrobotics/mycobot_ros2) or from Unity using [Unity's URDF controller script](https://github.com/Unity-Technologies/Unity-Robotics-Hub/blob/main/tutorials/urdf_importer/urdf_tutorial.md#using-the-controller). 
  * `Bidirectional_ZMQ`:
    * Sample scene to control the arm with Unity and Omniverse using ZMQ to pass data between applications. 
* `Scripts`:
  * `OV_ZMQ`: Scripts related to the `Bidirectional_ZMQ` scene
  * `PythonUtils`: Various python scripts used either for debugging or within Isaac Sim
    * Omniverse Scripts:
        * `get_pos_unity.py` is applied to the IK Target in OVIS. It gets the IK Target coordinates from Unity and applies them to the IK Target in OVIS. 
        * `send_joints.py` is applied to the robot xform in OVIS. It sends the joint angles from the OVIS IK calculation to Unity. 
    * Debugging Tools:
        * `pubsub_client.py` is a simple ZMQ client/consumer/subscriber.
        * `pubsub_server.py` is a simple ZMQ server/producer/publisher.
  * `ROS2`: Scripts related to the `Bidirectional_ZMQ`scene

## ROS2 Scene

To use the `Bidirectional_ROS2` scene, you will need to have completed the [Package Installation](https://github.com/uic-evl/digital-twin/wiki/Connecting-Unity-to-ROS2-on-Ubuntu-and-Windows-10#package-installation) section on our ROS2 to Unity wiki page. 

You will also need the Elephant Robotics ROS2 package installed. [See the wiki for tips.](https://github.com/uic-evl/digital-twin/wiki/Elephant-Robotics-Arms)

### Control arm visualization in Unity from ROS2 nodes (Unity Subscriber Test)
1. In a terminal (if Windows 11, this will be a WSL terminal):
   1. Launch Elephant Robotics slider control node with `ros2 launch myarm_300 slider_control.launch.py` 
   2. Launch the ROS TCP Endpoint ([described here](https://github.com/uic-evl/digital-twin/wiki/Connecting-Unity-to-ROS2-on-Ubuntu-and-Windows-10)) with `ros2 run ros_tcp_endpoint default_server_endpoint --ros-args -p ROS_IP:=<your IP address>`
      * You can find your IP address with:
        * Windows 10: `ipconfig`
        * Windows 11 in WSL: `hostname -I`
        * Ubuntu: `ifconfig`
2. In Unity, find the ROS settings at "Robotics > ROS Settings" and update the IP address. 
3. Press play on the game, then click the "Subscriber" button
4. Move the sliders from the ROS GUI, and observe the arm move in Unity. 

### Control physical arm from Unity using ROS2 messages (Unity Publisher Test)

This section is a work in progress. 

1. In a terminal (if Windows 11, this will be a WSL terminal):
   1. Launch the ROS TCP Endpoint ([described here](https://github.com/uic-evl/digital-twin/wiki/Connecting-Unity-to-ROS2-on-Ubuntu-and-Windows-10)) with `ros2 run ros_tcp_endpoint default_server_endpoint --ros-args -p ROS_IP:=<your IP address>`
      * You can find your IP address with:
        * Windows 10: `ipconfig`
        * Windows 11 in WSL: `hostname -I`
        * Ubuntu: `ifconfig`
2. In Unity, find the ROS settings at "Robotics > ROS Settings" and update the IP address. 
3. Press play on the game, then click the "Publisher" button
4. In another terminal, check that a "/joint_states" topic has been created with `ros2 topic list`
5. Affirm the data is being shared on the topic
   1. In a terminal, run `ros2 topic echo /joint_states`
   2. In the Unity Game view, use the arrow keys (as directed at the top of the screen) to control the imported URDF. You should see the joint angles in the output of the `ros2 topic echo /joint_states` command. 

## ZMQ Scene

> [!WARNING]  
> Do not press the "Stop Consumer" button before you have pressed "Stop Producer". This will cause the Unity editor to crash. 
